<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’èŠ±ç“·RGBé¢œè‰²å¯è§†åŒ–</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .controls input, .controls select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .controls input[type="text"] {
            flex: 1;
            min-width: 200px;
        }

        .controls select {
            min-width: 150px;
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
        }

        .card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
        }

        .card-header {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .card-header h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .card-header .id {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .card-header .type {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .image-container {
            width: 100%;
            height: 300px;
            overflow: hidden;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .card:hover .image-container img {
            transform: scale(1.05);
        }

        .image-container .loading {
            color: #999;
            font-size: 14px;
        }

        .colors-section {
            padding: 20px;
        }

        .colors-section h4 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1em;
        }

        .color-palette {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-item {
            flex: 1;
            min-width: 80px;
            max-width: 120px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .color-item:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .color-swatch {
            width: 100%;
            height: 60px;
            display: block;
        }

        .color-info {
            padding: 8px;
            background: #f8f8f8;
            text-align: center;
            font-size: 0.75em;
        }

        .color-rgb {
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .color-percentage {
            color: #666;
            font-size: 0.9em;
        }

        .color-bar {
            display: flex;
            height: 30px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .color-segment {
            height: 100%;
            transition: width 0.3s ease;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .stats {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stats span {
            margin: 0 15px;
            color: #666;
        }

        .stats strong {
            color: #667eea;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 0;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: #f5f5f5;
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8f9ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* åœ°å›¾å®¹å™¨æ ·å¼ */
        #map {
            height: 600px;
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* ä¿¡æ¯å¼¹çª—æ ·å¼ */
        .popup-content {
            max-width: 300px;
        }

        .popup-content img {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .popup-content h3 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 1.2em;
        }

        .popup-content p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #333;
        }

        .popup-content .label {
            font-weight: bold;
            color: #666;
        }

        .popup-content .description {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.85em;
            color: #555;
            line-height: 1.5;
        }

        /* æ•°æ®åˆ†æé¡µé¢æ ·å¼ */
        .analysis-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            margin: 0 0 15px 0;
            color: #667eea;
            font-size: 1.2em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 10px;
        }

        .chart-container.large {
            height: 400px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
        }

        .data-table {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9ff;
            color: #667eea;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ«– é’èŠ±ç“·RGBé¢œè‰²å¯è§†åŒ–</h1>
        
        <div class="tabs">
            <button class="tab-button active" data-tab="gallery">é¢œè‰²å¯è§†åŒ–</button>
            <button class="tab-button" data-tab="map">åœ°ç†åˆ†å¸ƒ</button>
            <button class="tab-button" data-tab="analysis">æ•°æ®åˆ†æ</button>
        </div>

        <!-- é¢œè‰²å¯è§†åŒ–æ ‡ç­¾é¡µ -->
        <div id="gallery-tab" class="tab-content active">
            <div class="stats">
                <span>æ€»å›¾ç‰‡æ•°: <strong id="total-count">0</strong></span>
                <span>æ˜¾ç¤º: <strong id="display-count">0</strong></span>
            </div>

            <div class="controls">
                <input type="text" id="search-input" placeholder="æœç´¢IDã€ç±»å‹æˆ–URL...">
                <select id="type-filter">
                    <option value="">æ‰€æœ‰ç±»å‹</option>
                </select>
                <select id="sort-select">
                    <option value="id-asc">ID å‡åº</option>
                    <option value="id-desc">ID é™åº</option>
                    <option value="colors-asc">é¢œè‰²æ•° å‡åº</option>
                    <option value="colors-desc">é¢œè‰²æ•° é™åº</option>
                </select>
            </div>

            <div id="gallery" class="gallery">
                <div class="empty-state">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- åœ°å›¾æ ‡ç­¾é¡µ -->
        <div id="map-tab" class="tab-content">
            <div class="stats">
                <span>æ€»ä½ç½®æ•°: <strong id="location-count">0</strong></span>
            </div>
            <div id="map"></div>
        </div>

        <!-- æ•°æ®åˆ†ææ ‡ç­¾é¡µ -->
        <div id="analysis-tab" class="tab-content">
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="label">æ€»è®°å½•æ•°</div>
                    <div class="value" id="stat-total">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">æœä»£ç§ç±»</div>
                    <div class="value" id="stat-periods">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">å™¨å‹ç§ç±»</div>
                    <div class="value" id="stat-types">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">è£…é¥°å…ƒç´ </div>
                    <div class="value" id="stat-elements">0</div>
                </div>
            </div>

            <div class="analysis-container">
                <div class="chart-card">
                    <h3>ğŸ“Š æœä»£åˆ†å¸ƒ</h3>
                    <div class="chart-container">
                        <canvas id="periods-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ğŸº å™¨å‹åˆ†å¸ƒï¼ˆTop 15ï¼‰</h3>
                    <div class="chart-container">
                        <canvas id="types-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ğŸ¨ è£…é¥°å…ƒç´ åˆ†å¸ƒï¼ˆTop 15ï¼‰</h3>
                    <div class="chart-container">
                        <canvas id="elements-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ğŸ“… æ—¶é—´åˆ†å¸ƒï¼ˆæŒ‰ä¸–çºªï¼‰</h3>
                    <div class="chart-container">
                        <canvas id="years-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ğŸ“ é«˜åº¦åˆ†å¸ƒ</h3>
                    <div class="chart-container">
                        <canvas id="height-chart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>ğŸ”„ æœä»£-å™¨å‹å…³ç³»</h3>
                    <div class="chart-container large">
                        <canvas id="heatmap-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="data-table">
                <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ“‹ è¯¦ç»†æ•°æ®è¡¨æ ¼</h3>
                <div style="margin-bottom: 10px;">
                    <input type="text" id="table-search" placeholder="æœç´¢..." style="padding: 8px; width: 300px; border: 2px solid #ddd; border-radius: 5px;">
                    <select id="table-filter-period" style="padding: 8px; margin-left: 10px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="">æ‰€æœ‰æœä»£</option>
                    </select>
                    <select id="table-filter-type" style="padding: 8px; margin-left: 10px; border: 2px solid #ddd; border-radius: 5px;">
                        <option value="">æ‰€æœ‰å™¨å‹</option>
                    </select>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>å¹´ä»£</th>
                                <th>æœä»£</th>
                                <th>å™¨å‹</th>
                                <th>é«˜åº¦</th>
                                <th>è£…é¥°å…ƒç´ </th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let locationData = [];
        let map = null;
        let analysisData = null;
        let charts = {};

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.classList.add('active');
                }
            });

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'gallery') {
                document.getElementById('gallery-tab').classList.add('active');
            } else if (tabName === 'map') {
                document.getElementById('map-tab').classList.add('active');
                // åˆå§‹åŒ–åœ°å›¾ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
                if (!map) {
                    initMap();
                }
            } else if (tabName === 'analysis') {
                document.getElementById('analysis-tab').classList.add('active');
                // åˆå§‹åŒ–æ•°æ®åˆ†æï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
                if (!analysisData) {
                    loadAnalysisData();
                }
            }
        }

        // ç»‘å®šæ ‡ç­¾é¡µæŒ‰é’®äº‹ä»¶ï¼ˆåœ¨DOMåŠ è½½å®Œæˆåï¼‰
        function initTabs() {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // åˆ›å»ºåœ°å›¾ï¼Œä¸­å¿ƒç‚¹è®¾ç½®ä¸ºä¸­å›½
            map = L.map('map').setView([35.0, 105.0], 4);

            // æ·»åŠ OpenStreetMapå›¾å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // åŠ è½½ä½ç½®æ•°æ®å¹¶æ·»åŠ æ ‡è®°
            loadLocationData();
        }

        // åŠ è½½ä½ç½®æ•°æ®
        async function loadLocationData() {
            try {
                const response = await fetch('location_data.json');
                locationData = await response.json();
                
                document.getElementById('location-count').textContent = locationData.length;

                // ä¸ºæ¯ä¸ªä½ç½®æ·»åŠ æ ‡è®°
                locationData.forEach(item => {
                    if (item.latitude && item.longitude) {
                        // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
                        const customIcon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="background-color: #667eea; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${item.id}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });

                        // åˆ›å»ºæ ‡è®°
                        const marker = L.marker([item.latitude, item.longitude], {
                            icon: customIcon
                        }).addTo(map);

                        // åˆ›å»ºå¼¹çª—å†…å®¹
                        let popupContent = `
                            <div class="popup-content">
                                <h3>ID: ${item.id} - ${item.location}</h3>
                        `;

                        if (item.url) {
                            popupContent += `<img src="${item.url}" alt="é’èŠ±ç“· ${item.id}" onerror="this.style.display='none'">`;
                        }

                        popupContent += `
                                <p><span class="label">æ—¶æœŸ:</span> ${item.periods || 'æœªçŸ¥'}</p>
                                <p><span class="label">å¹´ä»£:</span> ${item.date || 'æœªçŸ¥'}</p>
                                <p><span class="label">ç±»å‹:</span> ${item.type || 'æœªçŸ¥'}</p>
                                <p><span class="label">å°ºå¯¸:</span> ${item.size || 'æœªçŸ¥'}</p>
                                <p><span class="label">å…ƒç´ :</span> ${item.element || 'æœªçŸ¥'}</p>
                                <p><span class="label">å¯¹è±¡ç¼–å·:</span> ${item.objectNum || 'æœªçŸ¥'}</p>
                        `;

                        if (item.description) {
                            popupContent += `<div class="description"><span class="label">æè¿°:</span> ${item.description}</div>`;
                        }

                        popupContent += `</div>`;

                        // ç»‘å®šå¼¹çª—
                        marker.bindPopup(popupContent, {
                            maxWidth: 350
                        });
                    }
                });

                // å¦‚æœæœ‰æ ‡è®°ï¼Œè°ƒæ•´åœ°å›¾è§†å›¾ä»¥æ˜¾ç¤ºæ‰€æœ‰æ ‡è®°
                if (locationData.length > 0) {
                    const bounds = locationData
                        .filter(item => item.latitude && item.longitude)
                        .map(item => [item.latitude, item.longitude]);
                    
                    if (bounds.length > 0) {
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }

            } catch (error) {
                console.error('åŠ è½½ä½ç½®æ•°æ®å¤±è´¥:', error);
                document.getElementById('map').innerHTML = 
                    '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: white; border-radius: 10px; color: #666;">åŠ è½½ä½ç½®æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿location_data.jsonæ–‡ä»¶å­˜åœ¨</div>';
            }
        }

        // è§£æRGBé¢œè‰²å­—ç¬¦ä¸²
        function parseColors(colorString) {
            if (!colorString || colorString.trim() === '') return [];
            
            const colors = [];
            const parts = colorString.split(';');
            
            parts.forEach(part => {
                const match = part.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\):\s*([\d.]+)/);
                if (match) {
                    colors.push({
                        r: parseInt(match[1]),
                        g: parseInt(match[2]),
                        b: parseInt(match[3]),
                        percentage: parseFloat(match[4]),
                        rgb: `rgb(${match[1]}, ${match[2]}, ${match[3]})`
                    });
                }
            });
            
            return colors.sort((a, b) => b.percentage - a.percentage);
        }

        // å°†RGBè½¬æ¢ä¸ºåå…­è¿›åˆ¶
        function rgbToHex(r, g, b) {
            return "#" + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join("");
        }

        // åˆ›å»ºå¡ç‰‡HTML
        function createCard(item, index) {
            const colors = parseColors(item.rgb_color);
            const hasColors = colors.length > 0;
            
            let colorPaletteHTML = '';
            let colorBarHTML = '';
            
            if (hasColors) {
                colorPaletteHTML = colors.map(color => `
                    <div class="color-item" title="${color.rgb} - ${(color.percentage * 100).toFixed(1)}%">
                        <div class="color-swatch" style="background-color: ${color.rgb}"></div>
                        <div class="color-info">
                            <div class="color-rgb">${color.rgb}</div>
                            <div class="color-percentage">${(color.percentage * 100).toFixed(1)}%</div>
                        </div>
                    </div>
                `).join('');
                
                colorBarHTML = `<div class="color-bar">
                    ${colors.map(color => `
                        <div class="color-segment" style="width: ${color.percentage * 100}%; background-color: ${color.rgb}" 
                             title="${color.rgb} - ${(color.percentage * 100).toFixed(1)}%"></div>
                    `).join('')}
                </div>`;
            } else {
                colorPaletteHTML = '<div style="color: #999; padding: 20px; text-align: center;">æ— é¢œè‰²æ•°æ®</div>';
            }

            return `
                <div class="card" data-id="${item.id || index}" data-type="${item.type || ''}">
                    <div class="card-header">
                        <h3>${item.id ? `ID: ${item.id}` : 'æ— ID'}</h3>
                        <div class="id">${item.type || 'æœªçŸ¥ç±»å‹'}</div>
                        ${item.type ? `<span class="type">${item.type}</span>` : ''}
                    </div>
                    <div class="image-container">
                        ${item.URL ? 
                            `<img src="${item.URL}" alt="Image ${item.id || index}" loading="lazy" 
                                  onerror="this.parentElement.innerHTML='<div class=\\'loading\\'>å›¾ç‰‡åŠ è½½å¤±è´¥</div>'">` :
                            '<div class="loading">æ— å›¾ç‰‡URL</div>'
                        }
                    </div>
                    <div class="colors-section">
                        <h4>RGBé¢œè‰² (${colors.length}ç§)</h4>
                        <div class="color-palette">${colorPaletteHTML}</div>
                        ${colorBarHTML}
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“ç”»å»Š
        function renderGallery(data) {
            const gallery = document.getElementById('gallery');
            
            if (data.length === 0) {
                gallery.innerHTML = '<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»“æœ</div>';
                return;
            }
            
            gallery.innerHTML = data.map((item, index) => createCard(item, index)).join('');
            document.getElementById('display-count').textContent = data.length;
        }

        // è¿‡æ»¤å’Œæ’åº
        function filterAndSort() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const sortOption = document.getElementById('sort-select').value;
            
            filteredData = allData.filter(item => {
                const matchSearch = !searchTerm || 
                    (item.id && item.id.toString().toLowerCase().includes(searchTerm)) ||
                    (item.type && item.type.toLowerCase().includes(searchTerm)) ||
                    (item.URL && item.URL.toLowerCase().includes(searchTerm));
                
                const matchType = !typeFilter || item.type === typeFilter;
                
                return matchSearch && matchType;
            });
            
            // æ’åº
            filteredData.sort((a, b) => {
                const colorsA = parseColors(a.rgb_color).length;
                const colorsB = parseColors(b.rgb_color).length;
                
                switch(sortOption) {
                    case 'id-asc':
                        return (parseInt(a.id) || 0) - (parseInt(b.id) || 0);
                    case 'id-desc':
                        return (parseInt(b.id) || 0) - (parseInt(a.id) || 0);
                    case 'colors-asc':
                        return colorsA - colorsB;
                    case 'colors-desc':
                        return colorsB - colorsA;
                    default:
                        return 0;
                }
            });
            
            renderGallery(filteredData);
        }

        // åŠ è½½CSVæ•°æ®
        async function loadData() {
            try {
                const response = await fetch('color.csv');
                const text = await response.text();
                
                const lines = text.split('\n');
                const headers = lines[0].split(',');
                
                allData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    
                    // æ”¹è¿›çš„CSVè§£æï¼ˆå¤„ç†å¼•å·å†…çš„é€—å·ï¼‰
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < lines[i].length; j++) {
                        const char = lines[i][j];
                        const nextChar = lines[i][j + 1];
                        
                        if (char === '"') {
                            if (inQuotes && nextChar === '"') {
                                // è½¬ä¹‰çš„å¼•å·
                                current += '"';
                                j++;
                            } else {
                                // åˆ‡æ¢å¼•å·çŠ¶æ€
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            values.push(current);
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current); // æ·»åŠ æœ€åä¸€ä¸ªå€¼
                    
                    // ç§»é™¤å€¼çš„é¦–å°¾å¼•å·
                    const cleanedValues = values.map(v => {
                        let cleaned = v.trim();
                        if (cleaned.startsWith('"') && cleaned.endsWith('"')) {
                            cleaned = cleaned.slice(1, -1);
                        }
                        return cleaned;
                    });
                    
                    if (cleanedValues.length >= 3) {
                        const item = {
                            id: cleanedValues[0] || '',
                            type: cleanedValues[1] || '',
                            URL: cleanedValues[2] || '',
                            rgb_color: cleanedValues[3] || ''
                        };
                        allData.push(item);
                    }
                }
                
                // å¡«å……ç±»å‹è¿‡æ»¤å™¨
                const types = [...new Set(allData.map(item => item.type).filter(Boolean))].sort();
                const typeSelect = document.getElementById('type-filter');
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });
                
                document.getElementById('total-count').textContent = allData.length;
                filteredData = allData;
                filterAndSort();
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('gallery').innerHTML = 
                    '<div class="empty-state">åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿CSVæ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹</div>';
            }
        }

        // åŠ è½½åˆ†ææ•°æ®å¹¶åˆ›å»ºå›¾è¡¨
        async function loadAnalysisData() {
            try {
                const response = await fetch('analysis_data.json');
                analysisData = await response.json();
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                document.getElementById('stat-total').textContent = Object.values(analysisData.periods).reduce((a, b) => a + b, 0);
                document.getElementById('stat-periods').textContent = Object.keys(analysisData.periods).length;
                document.getElementById('stat-types').textContent = Object.keys(analysisData.types).length;
                document.getElementById('stat-elements').textContent = Object.keys(analysisData.elements).length;
                
                // åˆ›å»ºå›¾è¡¨
                createPeriodsChart();
                createTypesChart();
                createElementsChart();
                createYearsChart();
                createHeightChart();
                createHeatmapChart();
                createDataTable();
                
            } catch (error) {
                console.error('åŠ è½½åˆ†ææ•°æ®å¤±è´¥:', error);
                document.getElementById('analysis-tab').innerHTML = 
                    '<div class="empty-state">åŠ è½½åˆ†ææ•°æ®å¤±è´¥ï¼Œè¯·ç¡®ä¿analysis_data.jsonæ–‡ä»¶å­˜åœ¨</div>';
            }
        }

        // åˆ›å»ºæœä»£åˆ†å¸ƒé¥¼å›¾
        function createPeriodsChart() {
            const ctx = document.getElementById('periods-chart').getContext('2d');
            const labels = Object.keys(analysisData.periods);
            const values = Object.values(analysisData.periods);
            
            if (charts.periods) charts.periods.destroy();
            
            charts.periods = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#00f2fe', '#43e97b', '#fa709a', '#fee140',
                            '#30cfd0', '#a8edea'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // åˆ›å»ºå™¨å‹åˆ†å¸ƒæŸ±çŠ¶å›¾
        function createTypesChart() {
            const ctx = document.getElementById('types-chart').getContext('2d');
            const sorted = Object.entries(analysisData.types)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            if (charts.types) charts.types.destroy();
            
            charts.types = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ•°é‡',
                        data: values,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // åˆ›å»ºè£…é¥°å…ƒç´ æŸ±çŠ¶å›¾
        function createElementsChart() {
            const ctx = document.getElementById('elements-chart').getContext('2d');
            const sorted = Object.entries(analysisData.elements)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            if (charts.elements) charts.elements.destroy();
            
            charts.elements = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å‡ºç°æ¬¡æ•°',
                        data: values,
                        backgroundColor: '#764ba2'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // åˆ›å»ºæ—¶é—´åˆ†å¸ƒæŸ±çŠ¶å›¾
        function createYearsChart() {
            const ctx = document.getElementById('years-chart').getContext('2d');
            const sorted = Object.entries(analysisData.year_bins)
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            if (charts.years) charts.years.destroy();
            
            charts.years = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ•°é‡',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // åˆ›å»ºé«˜åº¦åˆ†å¸ƒæŸ±çŠ¶å›¾
        function createHeightChart() {
            const ctx = document.getElementById('height-chart').getContext('2d');
            const sorted = Object.entries(analysisData.height_bins)
                .sort((a, b) => {
                    const order = ['0-5cm', '5-10cm', '10-20cm', '20-30cm', '30-50cm', '50cm+'];
                    return order.indexOf(a[0]) - order.indexOf(b[0]);
                });
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            if (charts.height) charts.height.destroy();
            
            charts.height = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ•°é‡',
                        data: values,
                        backgroundColor: '#43e97b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // åˆ›å»ºçƒ­åŠ›å›¾ï¼ˆæœä»£-å™¨å‹å…³ç³»ï¼‰
        function createHeatmapChart() {
            const ctx = document.getElementById('heatmap-chart').getContext('2d');
            const periods = Object.keys(analysisData.period_type_cross);
            const allTypes = [...new Set(Object.values(analysisData.period_type_cross).flatMap(obj => Object.keys(obj)))];
            
            // å‡†å¤‡æ•°æ®
            const datasets = periods.map((period, idx) => {
                const periodData = analysisData.period_type_cross[period];
                return {
                    label: period,
                    data: allTypes.map(type => periodData[type] || 0),
                    backgroundColor: `hsl(${idx * 360 / periods.length}, 70%, 50%)`
                };
            });
            
            if (charts.heatmap) charts.heatmap.destroy();
            
            charts.heatmap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: allTypes.slice(0, 20), // é™åˆ¶æ˜¾ç¤ºå‰20ä¸ª
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false
                        },
                        y: {
                            beginAtZero: true,
                            stacked: false
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // åˆ›å»ºæ•°æ®è¡¨æ ¼
        async function createDataTable() {
            try {
                const response = await fetch('Processed_Data.csv');
                const text = await response.text();
                const lines = text.split('\n');
                const headers = lines[0].split(',');
                
                // è§£æCSV
                const tableData = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim() === '') continue;
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= 6) {
                        tableData.push({
                            id: values[0] || '',
                            date: values[1] || '',
                            period: values[4] || '',
                            type: values[8] || '',
                            height: values[2] || '',
                            element: values[7] || ''
                        });
                    }
                }
                
                // å¡«å……è¿‡æ»¤å™¨é€‰é¡¹
                const periods = [...new Set(tableData.map(d => d.period).filter(Boolean))].sort();
                const types = [...new Set(tableData.map(d => d.type).filter(Boolean))].sort();
                
                const periodSelect = document.getElementById('table-filter-period');
                periods.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    periodSelect.appendChild(option);
                });
                
                const typeSelect = document.getElementById('table-filter-type');
                types.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t;
                    option.textContent = t;
                    typeSelect.appendChild(option);
                });
                
                // æ¸²æŸ“è¡¨æ ¼
                function renderTable(data) {
                    const tbody = document.getElementById('table-body');
                    tbody.innerHTML = data.map(item => `
                        <tr>
                            <td>${item.id}</td>
                            <td>${item.date}</td>
                            <td>${item.period}</td>
                            <td>${item.type}</td>
                            <td>${item.height}</td>
                            <td>${item.element || '-'}</td>
                        </tr>
                    `).join('');
                }
                
                renderTable(tableData);
                
                // æœç´¢å’Œè¿‡æ»¤
                function filterTable() {
                    const search = document.getElementById('table-search').value.toLowerCase();
                    const periodFilter = document.getElementById('table-filter-period').value;
                    const typeFilter = document.getElementById('table-filter-type').value;
                    
                    const filtered = tableData.filter(item => {
                        const matchSearch = !search || 
                            item.id.toLowerCase().includes(search) ||
                            item.date.toLowerCase().includes(search) ||
                            item.period.toLowerCase().includes(search) ||
                            item.type.toLowerCase().includes(search) ||
                            (item.element && item.element.toLowerCase().includes(search));
                        const matchPeriod = !periodFilter || item.period === periodFilter;
                        const matchType = !typeFilter || item.type === typeFilter;
                        return matchSearch && matchPeriod && matchType;
                    });
                    
                    renderTable(filtered);
                }
                
                document.getElementById('table-search').addEventListener('input', filterTable);
                document.getElementById('table-filter-period').addEventListener('change', filterTable);
                document.getElementById('table-filter-type').addEventListener('change', filterTable);
                
            } catch (error) {
                console.error('åŠ è½½è¡¨æ ¼æ•°æ®å¤±è´¥:', error);
            }
        }

        // CSVè§£æè¾…åŠ©å‡½æ•°
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            return values;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            initTabs();
            loadData();
            
            // äº‹ä»¶ç›‘å¬
            document.getElementById('search-input').addEventListener('input', filterAndSort);
            document.getElementById('type-filter').addEventListener('change', filterAndSort);
            document.getElementById('sort-select').addEventListener('change', filterAndSort);
        });
    </script>
</body>
</html>

